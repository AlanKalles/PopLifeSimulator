# é¼ æ ‡è‡ªåŠ¨æ£€æµ‹æ¥¼å±‚å»ºé€ ç³»ç»Ÿ - æŠ€æœ¯è®¡åˆ’

**é¡¹ç›®**: Pop Life Simulator
**ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-10-11
**çŠ¶æ€**: å¾…å®æ–½

---

## âš ï¸ é‡è¦æç¤º

**æ¯æ¬¡æ‰§è¡Œä»»ä½•é˜¶æ®µæˆ–ä»»åŠ¡æ—¶ï¼Œå¿…é¡»åŒæ­¥æ›´æ–°ã€Šé¼ æ ‡è‡ªåŠ¨æ£€æµ‹æ¥¼å±‚å»ºé€ ç³»ç»Ÿ-å®æ–½æ—¥å¿—.mdã€‹**

æ—¥å¿—æ›´æ–°è¦æ±‚ï¼š
- å¼€å§‹ä»»åŠ¡å‰ï¼šè®°å½•ä»»åŠ¡å¼€å§‹æ—¶é—´ã€è´Ÿè´£äºº
- å®Œæˆä»»åŠ¡åï¼šè®°å½•å®Œæˆæ—¶é—´ã€å®æ–½ç»“æœã€é‡åˆ°çš„é—®é¢˜
- æµ‹è¯•ç»“æœï¼šè®°å½•æµ‹è¯•ç”¨ä¾‹é€šè¿‡æƒ…å†µ
- ä»£ç ä½ç½®ï¼šè®°å½•ä¿®æ”¹çš„æ–‡ä»¶å’Œè¡Œå·

---

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 å½“å‰é—®é¢˜
- ç”¨æˆ·éœ€è¦å…ˆæŒ‰Tab/æ•°å­—é”®é€‰æ‹©æ¥¼å±‚
- å†ç§»åŠ¨é¼ æ ‡å®šä½ç½‘æ ¼ä½ç½®
- ä¸¤æ­¥æ“ä½œï¼Œè®¤çŸ¥è´Ÿæ‹…é«˜

### 1.2 æ”¹é€ ç›®æ ‡
- âœ… ç‚¹å‡»å»ºé€ æŒ‰é’® â†’ è¿›å…¥é¢„è§ˆæ¨¡å¼
- âœ… é¼ æ ‡ç§»åŠ¨åˆ°ä»»æ„æ¥¼å±‚ â†’ è‡ªåŠ¨åœ¨è¯¥æ¥¼å±‚æ˜¾ç¤ºç½‘æ ¼é¢„è§ˆ
- âœ… ç‚¹å‡»ç¡®è®¤ â†’ åœ¨å½“å‰é¼ æ ‡æ‰€åœ¨æ¥¼å±‚æ”¾ç½®å»ºç­‘
- âœ… **æ— éœ€æ‰‹åŠ¨åˆ‡æ¢æ¥¼å±‚**
- âœ… **Placeæ¨¡å¼å’ŒMoveæ¨¡å¼éƒ½æ”¯æŒè‡ªåŠ¨æ£€æµ‹**

### 1.3 è®¾è®¡çº¦æŸ
- âŒ **ä¸æ”¯æŒå»ºç­‘ç‰©æ—‹è½¬åŠŸèƒ½**ï¼ˆå·²ä»ç³»ç»Ÿä¸­ç§»é™¤ï¼‰
- âœ… **Moveæ¨¡å¼å¿…é¡»æ”¯æŒè‡ªåŠ¨æ¥¼å±‚æ£€æµ‹**
- âœ… ä¿æŒä¸ç°æœ‰ç³»ç»Ÿçš„å…¼å®¹æ€§

---

## äºŒã€æŠ€æœ¯æ¶æ„

### 2.1 ç³»ç»Ÿåˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é¼ æ ‡è¾“å…¥ (Mouse Input)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ FloorDetector     â”‚  â† æ–°å¢æœåŠ¡
         â”‚ (æ¯å¸§æ£€æµ‹æ¥¼å±‚)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ FloorManager      â”‚  â† æ‰©å±•æ¥å£
         â”‚ (ç®¡ç†æ¥¼å±‚åˆ‡æ¢)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ConstructionMgr   â”‚  â† æ ¸å¿ƒæ”¹é€ 
         â”‚ (Place & Move)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ”¹åŠ¨ç‚¹

| ç»„ä»¶ | æ”¹åŠ¨ç±»å‹ | æ”¹åŠ¨å†…å®¹ |
|------|---------|---------|
| **FloorDetectionService** | æ–°å¢ | é¼ æ ‡æ¥¼å±‚æ£€æµ‹æœåŠ¡ |
| **FloorGrid** | æ‰©å±• | æ·»åŠ æ£€æµ‹ç¢°æ’ä½“ |
| **FloorManager** | æ‰©å±• | ç¨‹åºåŒ–åˆ‡æ¢æ¥å£ |
| **ConstructionManager** | æ”¹é€  | Placeå’ŒMoveæ¨¡å¼è‡ªåŠ¨æ£€æµ‹ |

---

## ä¸‰ã€åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šæ¥¼å±‚æ£€æµ‹ç³»ç»Ÿæ­å»º

#### ä»»åŠ¡1.1ï¼šä¸ºFloorGridæ·»åŠ æ£€æµ‹ç¢°æ’ä½“ â±ï¸ é¢„è®¡1å°æ—¶

**ğŸ“‹ å®æ–½å‰æ£€æŸ¥æ¸…å•**
- [ ] å¤‡ä»½ `FloorGrid.cs` æ–‡ä»¶
- [ ] åœ¨ProjectSettingsä¸­åˆ›å»º `FloorDetection` Layerï¼ˆID: 31ï¼‰
- [ ] é…ç½®Layer Collision Matrix

**ğŸ“ å®æ–½æ­¥éª¤**

1. **ä¿®æ”¹æ–‡ä»¶**: `Assets/Scripts/Runtime/FloorGrid.cs`

2. **åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­æ·»åŠ Collider**ï¼ˆ`Start()` æˆ– `Awake()`ï¼‰ï¼š
   ```csharp
   private void InitializeFloorDetection()
   {
       // æ£€æŸ¥æ˜¯å¦å·²æœ‰BoxCollider2D
       BoxCollider2D collider = GetComponent<BoxCollider2D>();
       if (collider == null) {
           collider = gameObject.AddComponent<BoxCollider2D>();
       }

       // é…ç½®Collider
       collider.isTrigger = true;

       // è®¡ç®—Colliderå¤§å°
       Vector2 gridSize = new Vector2(
           gridWidth * cellSize,
           gridHeight * cellSize
       );
       collider.size = gridSize;

       // è®¡ç®—ä¸­å¿ƒç‚¹ï¼ˆè€ƒè™‘originOffsetï¼‰
       Vector2 center = new Vector2(
           gridSize.x / 2f,
           gridSize.y / 2f
       ) + originOffset;
       collider.offset = center;

       // è®¾ç½®ä¸“ç”¨Layer
       gameObject.layer = LayerMask.NameToLayer("FloorDetection");
   }
   ```

3. **åœ¨ç°æœ‰åˆå§‹åŒ–æµç¨‹ä¸­è°ƒç”¨**ï¼š
   ```csharp
   private void Start() {
       // ... ç°æœ‰ä»£ç 
       InitializeFloorDetection();
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] æ¯ä¸ªFloorGridè‡ªåŠ¨æ·»åŠ BoxCollider2D
- [ ] Colliderå¤§å°ä¸ç½‘æ ¼å°ºå¯¸åŒ¹é…
- [ ] Layeræ­£ç¡®è®¾ç½®ä¸º `FloorDetection`
- [ ] isTrigger = true
- [ ] Sceneè§†å›¾ä¸­Colliderå¯è§ï¼ˆç»¿è‰²è¾¹æ¡†ï¼‰

**ğŸ“Œ è®°å½•è¦æ±‚**: å®Œæˆååœ¨æ—¥å¿—ä¸­è®°å½•ä¿®æ”¹çš„ä»£ç è¡Œå·

---

#### ä»»åŠ¡1.2ï¼šåˆ›å»ºæ¥¼å±‚æ£€æµ‹æœåŠ¡ â±ï¸ é¢„è®¡2å°æ—¶

**ğŸ“‹ å®æ–½å‰æ£€æŸ¥æ¸…å•**
- [ ] ç¡®è®¤ `Assets/Scripts/Services/` ç›®å½•å­˜åœ¨ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
- [ ] ç¡®è®¤FloorGridçš„Colliderå·²æ­£ç¡®é…ç½®

**ğŸ“ å®æ–½æ­¥éª¤**

1. **åˆ›å»ºæ–‡ä»¶**: `Assets/Scripts/Services/FloorDetectionService.cs`

2. **å‘½åç©ºé—´**: `PopLife.Services`

3. **æ ¸å¿ƒæ¥å£è®¾è®¡**:
   ```csharp
   public class FloorDetectionService
   {
       // === é…ç½® ===
       private readonly int detectionInterval;  // æ£€æµ‹é—´éš”ï¼ˆå¸§ï¼‰
       private readonly Camera targetCamera;    // ç›®æ ‡ç›¸æœº
       private readonly LayerMask floorLayer;   // æ¥¼å±‚Layer

       // === ç¼“å­˜ ===
       private FloorGrid cachedFloor;           // ä¸Šä¸€å¸§æ£€æµ‹ç»“æœ
       private int frameCounter;                // å¸§è®¡æ•°å™¨

       // === æ„é€ å‡½æ•° ===
       public FloorDetectionService(
           Camera camera,
           int interval = 3
       ) {
           targetCamera = camera;
           detectionInterval = interval;
           floorLayer = LayerMask.GetMask("FloorDetection");
       }

       // === æ ¸å¿ƒæ–¹æ³• ===
       public FloorGrid DetectFloorAtMouse();

       // === è¾…åŠ©æ–¹æ³• ===
       private Vector2 GetMouseWorldPosition();
       private FloorGrid RaycastFloor(Vector2 worldPos);
   }
   ```

4. **å®ç° `GetMouseWorldPosition()`**:
   ```csharp
   private Vector2 GetMouseWorldPosition()
   {
       Vector3 mousePos = Input.mousePosition;
       mousePos.z = 0f;
       Vector2 worldPos = targetCamera.ScreenToWorldPoint(mousePos);
       return worldPos;
   }
   ```

5. **å®ç° `RaycastFloor()`**:
   ```csharp
   private FloorGrid RaycastFloor(Vector2 worldPos)
   {
       // ä½¿ç”¨é›¶è·ç¦»å°„çº¿ï¼ˆç‚¹æ£€æµ‹ï¼‰
       RaycastHit2D hit = Physics2D.Raycast(
           worldPos,
           Vector2.zero,
           0f,
           floorLayer
       );

       if (hit.collider != null) {
           return hit.collider.GetComponent<FloorGrid>();
       }

       return null;
   }
   ```

6. **å®ç° `DetectFloorAtMouse()`**ï¼ˆå«æ€§èƒ½ä¼˜åŒ–ï¼‰:
   ```csharp
   public FloorGrid DetectFloorAtMouse()
   {
       // é—´éš”å¸§æ£€æµ‹ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
       frameCounter++;
       if (frameCounter < detectionInterval) {
           return cachedFloor;
       }
       frameCounter = 0;

       // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨UIä¸Š
       if (UnityEngine.EventSystems.EventSystem.current != null &&
           UnityEngine.EventSystems.EventSystem.current.IsPointerOverGameObject()) {
           cachedFloor = null;
           return null;
       }

       // æ‰§è¡Œæ£€æµ‹
       Vector2 mousePos = GetMouseWorldPosition();
       FloorGrid detected = RaycastFloor(mousePos);

       cachedFloor = detected;
       return detected;
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] æ–‡ä»¶æˆåŠŸåˆ›å»ºï¼Œæ— ç¼–è¯‘é”™è¯¯
- [ ] é¼ æ ‡åœ¨æ¥¼å±‚ä¸Šè¿”å›æ­£ç¡®çš„FloorGrid
- [ ] é¼ æ ‡ä¸åœ¨æ¥¼å±‚ä¸Šè¿”å›null
- [ ] é¼ æ ‡åœ¨UIä¸Šè¿”å›null
- [ ] é—´éš”å¸§æ£€æµ‹æ­£å¸¸å·¥ä½œ

**ğŸ“Œ è®°å½•è¦æ±‚**: å®Œæˆååœ¨æ—¥å¿—ä¸­è®°å½•æ–‡ä»¶è·¯å¾„å’Œæ ¸å¿ƒæ–¹æ³•

---

### é˜¶æ®µ2ï¼šFloorManageræ‰©å±•

#### ä»»åŠ¡2.1ï¼šå¢åŠ ç¨‹åºåŒ–åˆ‡æ¢æ¥å£ â±ï¸ é¢„è®¡1å°æ—¶

**ğŸ“‹ å®æ–½å‰æ£€æŸ¥æ¸…å•**
- [ ] å¤‡ä»½ `FloorManager.cs` æ–‡ä»¶
- [ ] äº†è§£å½“å‰çš„ `ActiveFloor` åˆ‡æ¢é€»è¾‘

**ğŸ“ å®æ–½æ­¥éª¤**

1. **ä¿®æ”¹æ–‡ä»¶**: `Assets/Scripts/Manager/FloorManager.cs`

2. **æ–°å¢äº‹ä»¶å®šä¹‰**ï¼ˆç±»é¡¶éƒ¨ï¼‰:
   ```csharp
   public event Action<FloorGrid> OnActiveFloorChanged;
   ```

3. **æ–°å¢å…¬å…±æ–¹æ³•**:
   ```csharp
   /// <summary>
   /// ç¨‹åºåŒ–åˆ‡æ¢åˆ°æŒ‡å®šæ¥¼å±‚ï¼ˆç”±æ£€æµ‹ç³»ç»Ÿè°ƒç”¨ï¼‰
   /// </summary>
   /// <param name="targetFloor">ç›®æ ‡æ¥¼å±‚ï¼Œnullè¡¨ç¤ºå–æ¶ˆæ¿€æ´»</param>
   public void SetActiveFloorProgrammatic(FloorGrid targetFloor)
   {
       // é¿å…é‡å¤åˆ‡æ¢
       if (targetFloor == currentActiveFloor) {
           return;
       }

       // åœç”¨æ—§æ¥¼å±‚
       if (currentActiveFloor != null) {
           currentActiveFloor.SetActive(false);
           // å¯é€‰ï¼šç§»é™¤è§†è§‰é«˜äº®
           SetFloorHighlight(currentActiveFloor, false);
       }

       // æ¿€æ´»æ–°æ¥¼å±‚
       currentActiveFloor = targetFloor;
       if (targetFloor != null) {
           targetFloor.SetActive(true);
           // å¯é€‰ï¼šæ·»åŠ è§†è§‰é«˜äº®
           SetFloorHighlight(targetFloor, true);
       }

       // è§¦å‘äº‹ä»¶
       OnActiveFloorChanged?.Invoke(targetFloor);
   }
   ```

4. **å¯é€‰ï¼šè§†è§‰é«˜äº®æ–¹æ³•**:
   ```csharp
   private void SetFloorHighlight(FloorGrid floor, bool enabled)
   {
       SpriteRenderer sr = floor.GetComponent<SpriteRenderer>();
       if (sr == null) {
           sr = floor.gameObject.AddComponent<SpriteRenderer>();
           sr.sortingOrder = -100;  // ç¡®ä¿åœ¨æœ€åº•å±‚
       }

       if (enabled) {
           sr.color = new Color(0.5f, 0.8f, 1f, 0.3f);  // æ·¡è“è‰²é«˜äº®
       } else {
           sr.color = new Color(1f, 1f, 1f, 0.05f);     // å‡ ä¹é€æ˜
       }
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] `SetActiveFloorProgrammatic()` æ–¹æ³•å¯æ­£å¸¸è°ƒç”¨
- [ ] åˆ‡æ¢æ¥¼å±‚æ—¶è§¦å‘ `OnActiveFloorChanged` äº‹ä»¶
- [ ] å¯é€‰ï¼šè§†è§‰é«˜äº®æ­£å¸¸æ˜¾ç¤º
- [ ] åŸæœ‰Tabé”®åŠŸèƒ½ä¸å—å½±å“ï¼ˆå¯é€‰ä¿ç•™ï¼‰

**ğŸ“Œ è®°å½•è¦æ±‚**: å®Œæˆååœ¨æ—¥å¿—ä¸­è®°å½•æ–°å¢çš„å…¬å…±æ¥å£

---

### é˜¶æ®µ3ï¼šConstructionManageræ ¸å¿ƒæ”¹é€ 

#### ä»»åŠ¡3.1ï¼šé›†æˆæ¥¼å±‚æ£€æµ‹æœåŠ¡ â±ï¸ é¢„è®¡30åˆ†é’Ÿ

**ğŸ“‹ å®æ–½å‰æ£€æŸ¥æ¸…å•**
- [ ] å¤‡ä»½ `ConstructionManager.cs` æ–‡ä»¶
- [ ] ç¡®è®¤FloorDetectionServiceå·²å®ç°

**ğŸ“ å®æ–½æ­¥éª¤**

1. **ä¿®æ”¹æ–‡ä»¶**: `Assets/Scripts/Runtime/ConstructionManager.cs`

2. **æ–°å¢å­—æ®µ**ï¼ˆç±»é¡¶éƒ¨ï¼‰:
   ```csharp
   // === æ¥¼å±‚æ£€æµ‹ ===
   private FloorDetectionService floorDetector;
   private FloorGrid currentDetectedFloor;  // å½“å‰æ£€æµ‹åˆ°çš„æ¥¼å±‚
   private FloorGrid lastPreviewFloor;      // ä¸Šä¸€æ¬¡é¢„è§ˆæ‰€åœ¨æ¥¼å±‚
   ```

3. **åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­åˆ›å»ºæ£€æµ‹æœåŠ¡**ï¼ˆ`Start()` æˆ– `Awake()`ï¼‰:
   ```csharp
   private void Start()
   {
       // ... ç°æœ‰ä»£ç 

       // åˆå§‹åŒ–æ¥¼å±‚æ£€æµ‹æœåŠ¡
       floorDetector = new FloorDetectionService(
           Camera.main,
           detectionInterval: 3  // æ¯3å¸§æ£€æµ‹ä¸€æ¬¡
       );
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] FloorDetectionServiceæˆåŠŸå®ä¾‹åŒ–
- [ ] æ— ç¼–è¯‘é”™è¯¯

**ğŸ“Œ è®°å½•è¦æ±‚**: å®Œæˆååœ¨æ—¥å¿—ä¸­è®°å½•é›†æˆä½ç½®

---

#### ä»»åŠ¡3.2ï¼šæ”¹é€ Placeæ¨¡å¼çš„Updateé€»è¾‘ â±ï¸ é¢„è®¡2å°æ—¶

**ğŸ“‹ å®æ–½å‰æ£€æŸ¥æ¸…å•**
- [ ] ç†è§£å½“å‰çš„Placeæ¨¡å¼æµç¨‹
- [ ] ç¡®è®¤FloorManagerçš„ `SetActiveFloorProgrammatic()` å¯ç”¨

**ğŸ“ å®æ–½æ­¥éª¤**

1. **å®šä½ç°æœ‰çš„Placeæ¨¡å¼é€»è¾‘**ï¼ˆåœ¨ `Update()` æ–¹æ³•ä¸­ï¼‰

2. **é‡æ„Update()ä¸­çš„Placeæ¨¡å¼åˆ†æ”¯**:

**æ—§é€»è¾‘**ï¼ˆä¼ªä»£ç ï¼‰:
```csharp
if (mode == ConstructionMode.Place) {
    UpdatePreviewPosition();  // åŸºäºå½“å‰é€‰ä¸­æ¥¼å±‚
    HandlePlaceInput();
}
```

**æ–°é€»è¾‘**ï¼ˆä¼ªä»£ç ï¼‰:
```csharp
if (mode == ConstructionMode.Place) {
    // 1. æ£€æµ‹é¼ æ ‡æ‰€åœ¨æ¥¼å±‚
    currentDetectedFloor = floorDetector.DetectFloorAtMouse();

    // 2. æ¥¼å±‚å˜åŒ–æ—¶åˆ‡æ¢é¢„è§ˆ
    if (currentDetectedFloor != lastPreviewFloor) {
        SwitchPreviewFloor(currentDetectedFloor);
        lastPreviewFloor = currentDetectedFloor;
    }

    // 3. æ›´æ–°é¢„è§ˆä½ç½®
    if (currentDetectedFloor != null) {
        UpdatePreviewPosition(currentDetectedFloor);
    } else {
        HidePreview();
    }

    // 4. å¤„ç†æ”¾ç½®è¾“å…¥
    if (currentDetectedFloor != null) {
        HandlePlaceInput(currentDetectedFloor);
    }
}
```

3. **å®ç° `SwitchPreviewFloor()` æ–¹æ³•**:
   ```csharp
   private void SwitchPreviewFloor(FloorGrid newFloor)
   {
       // 1. æ¸…ç†æ—§é¢„è§ˆ
       if (previewInstance != null) {
           Destroy(previewInstance);
           previewInstance = null;
       }

       // 2. å¦‚æœæ–°æ¥¼å±‚ä¸ºnullï¼ˆé¼ æ ‡ç¦»å¼€æ‰€æœ‰æ¥¼å±‚ï¼‰
       if (newFloor == null) {
           return;
       }

       // 3. åˆ‡æ¢FloorManagerçš„å½“å‰æ¥¼å±‚
       FloorManager.Instance.SetActiveFloorProgrammatic(newFloor);

       // 4. é‡æ–°åˆ›å»ºé¢„è§ˆå¯¹è±¡
       CreatePreviewInstance();  // è°ƒç”¨ç°æœ‰æ–¹æ³•æˆ–å®ç°æ–°æ–¹æ³•
   }
   ```

4. **ä¿®æ”¹ `UpdatePreviewPosition()` æ–¹æ³•ç­¾å**:

**æ—§æ–¹æ³•**:
```csharp
private void UpdatePreviewPosition()
{
    FloorGrid floor = FloorManager.Instance.ActiveFloor;
    // ... åŸºäºActiveFloorçš„é€»è¾‘
}
```

**æ–°æ–¹æ³•**:
```csharp
private void UpdatePreviewPosition(FloorGrid targetFloor)
{
    // ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„targetFloor
    Vector2Int gridPos = GetGridPositionFromMouse(targetFloor);

    // æ›´æ–°é¢„è§ˆä½ç½®
    // ...

    // éªŒè¯å¯æ”¾ç½®æ€§
    bool canPlace = ValidatePlacement(targetFloor, gridPos);
    UpdatePreviewColor(canPlace);
}
```

5. **å®ç° `HidePreview()` æ–¹æ³•**:
   ```csharp
   private void HidePreview()
   {
       if (previewInstance != null) {
           // æ–¹æ¡ˆ1ï¼šè®¾ç½®é€æ˜åº¦ä¸º0
           var renderers = previewInstance.GetComponentsInChildren<SpriteRenderer>();
           foreach (var sr in renderers) {
               Color c = sr.color;
               c.a = 0f;
               sr.color = c;
           }

           // æ–¹æ¡ˆ2ï¼šæˆ–è€…ç›´æ¥ç¦ç”¨GameObject
           // previewInstance.SetActive(false);
       }
   }
   ```

6. **ä¿®æ”¹ `HandlePlaceInput()` æ–¹æ³•**:
   ```csharp
   private void HandlePlaceInput(FloorGrid targetFloor)
   {
       if (Input.GetMouseButtonDown(0)) {  // å·¦é”®ç‚¹å‡»
           Vector2Int gridPos = GetGridPositionFromMouse(targetFloor);

           if (ValidatePlacement(targetFloor, gridPos)) {
               PlaceBuilding(targetFloor, gridPos);
           }
       }
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] Placeæ¨¡å¼ä¸‹ï¼Œé¼ æ ‡ç§»åŠ¨åˆ°ä¸åŒæ¥¼å±‚ï¼Œé¢„è§ˆè‡ªåŠ¨åˆ‡æ¢
- [ ] é¼ æ ‡ç¦»å¼€æ‰€æœ‰æ¥¼å±‚ï¼Œé¢„è§ˆéšè—
- [ ] ç‚¹å‡»æ”¾ç½®ï¼Œå»ºç­‘å‡ºç°åœ¨æ­£ç¡®æ¥¼å±‚å’Œä½ç½®
- [ ] é¢„è§ˆé¢œè‰²æ­£ç¡®ï¼ˆç»¿è‰²=å¯å»ºé€ ï¼Œçº¢è‰²=ä¸å¯ï¼‰

**ğŸ“Œ è®°å½•è¦æ±‚**: å®Œæˆååœ¨æ—¥å¿—ä¸­è®°å½•ä¿®æ”¹çš„æ–¹æ³•åˆ—è¡¨

---

#### ä»»åŠ¡3.3ï¼šæ”¹é€ Moveæ¨¡å¼çš„Updateé€»è¾‘ â±ï¸ é¢„è®¡2å°æ—¶

**ğŸ“‹ å®æ–½å‰æ£€æŸ¥æ¸…å•**
- [ ] ç†è§£å½“å‰çš„Moveæ¨¡å¼æµç¨‹
- [ ] ç¡®è®¤æ˜¯å¦æ”¯æŒè·¨æ¥¼å±‚ç§»åŠ¨

**ğŸ“ å®æ–½æ­¥éª¤**

1. **å®šä½ç°æœ‰çš„Moveæ¨¡å¼é€»è¾‘**ï¼ˆåœ¨ `Update()` æ–¹æ³•ä¸­ï¼‰

2. **é‡æ„Update()ä¸­çš„Moveæ¨¡å¼åˆ†æ”¯**:

**æ–°é€»è¾‘**ï¼ˆä¼ªä»£ç ï¼‰:
```csharp
if (mode == ConstructionMode.Move) {
    // 1. æ£€æµ‹é¼ æ ‡æ‰€åœ¨æ¥¼å±‚
    currentDetectedFloor = floorDetector.DetectFloorAtMouse();

    // 2. æ¥¼å±‚å˜åŒ–æ—¶åˆ‡æ¢é¢„è§ˆ
    if (currentDetectedFloor != lastPreviewFloor) {
        SwitchMovePreviewFloor(currentDetectedFloor);
        lastPreviewFloor = currentDetectedFloor;
    }

    // 3. æ›´æ–°é¢„è§ˆä½ç½®
    if (currentDetectedFloor != null) {
        UpdateMovePreviewPosition(currentDetectedFloor);
    } else {
        HideMovePreview();
    }

    // 4. å¤„ç†ç§»åŠ¨ç¡®è®¤è¾“å…¥
    if (currentDetectedFloor != null) {
        HandleMoveInput(currentDetectedFloor);
    }
}
```

3. **å®ç° `SwitchMovePreviewFloor()` æ–¹æ³•**:
   ```csharp
   private void SwitchMovePreviewFloor(FloorGrid newFloor)
   {
       if (newFloor == null) {
           return;
       }

       // æ£€æŸ¥æ˜¯å¦è·¨æ¥¼å±‚ç§»åŠ¨
       bool isCrossFloor = (newFloor != selectedBuilding.ParentFloor);

       // åˆ‡æ¢FloorManagerçš„å½“å‰æ¥¼å±‚
       FloorManager.Instance.SetActiveFloorProgrammatic(newFloor);

       // æ›´æ–°ç§»åŠ¨æˆæœ¬æ˜¾ç¤ºï¼ˆè·¨æ¥¼å±‚æˆæœ¬Ã—2ï¼‰
       if (isCrossFloor) {
           UpdateMoveCostUI(baseCost * 2);
       } else {
           UpdateMoveCostUI(baseCost);
       }
   }
   ```

4. **å®ç° `UpdateMovePreviewPosition()` æ–¹æ³•**:
   ```csharp
   private void UpdateMovePreviewPosition(FloorGrid targetFloor)
   {
       Vector2Int gridPos = GetGridPositionFromMouse(targetFloor);

       // æ£€æŸ¥æ˜¯å¦å¯ç§»åŠ¨åˆ°è¯¥ä½ç½®
       bool canMove = ValidateMove(targetFloor, gridPos);

       // æ›´æ–°é¢„è§ˆå¤–è§‚
       UpdateMovePreviewColor(canMove);

       // æ›´æ–°é¢„è§ˆä½ç½®
       if (movePreviewInstance != null) {
           Vector3 worldPos = targetFloor.GridToWorldPosition(gridPos);
           movePreviewInstance.transform.position = worldPos;
       }
   }
   ```

5. **å®ç° `ValidateMove()` æ–¹æ³•**:
   ```csharp
   private bool ValidateMove(FloorGrid targetFloor, Vector2Int gridPos)
   {
       // 1. æ£€æŸ¥ç½‘æ ¼æ˜¯å¦å¯ç”¨ï¼ˆæ’é™¤è‡ªèº«å ç”¨ï¼‰
       bool gridAvailable = targetFloor.IsCellAvailableForMove(
           gridPos,
           selectedBuilding
       );

       // 2. æ£€æŸ¥èµ„æºï¼ˆç§»åŠ¨è´¹ç”¨ï¼‰
       bool isCrossFloor = (targetFloor != selectedBuilding.ParentFloor);
       int moveCost = isCrossFloor ? baseCost * 2 : baseCost;
       bool canAfford = ResourceManager.Instance.Money >= moveCost;

       return gridAvailable && canAfford;
   }
   ```

6. **å®ç° `HandleMoveInput()` æ–¹æ³•**:
   ```csharp
   private void HandleMoveInput(FloorGrid targetFloor)
   {
       if (Input.GetMouseButtonDown(0)) {  // å·¦é”®ç¡®è®¤ç§»åŠ¨
           Vector2Int gridPos = GetGridPositionFromMouse(targetFloor);

           if (ValidateMove(targetFloor, gridPos)) {
               ExecuteMove(targetFloor, gridPos);
           }
       }

       if (Input.GetMouseButtonDown(1)) {  // å³é”®å–æ¶ˆ
           ExitMoveMode();
       }
   }
   ```

7. **å®ç° `ExecuteMove()` æ–¹æ³•**:
   ```csharp
   private void ExecuteMove(FloorGrid targetFloor, Vector2Int newGridPos)
   {
       // 1. è®¡ç®—ç§»åŠ¨æˆæœ¬
       bool isCrossFloor = (targetFloor != selectedBuilding.ParentFloor);
       int moveCost = isCrossFloor ? baseCost * 2 : baseCost;

       // 2. ä»åŸä½ç½®æ³¨é”€
       FloorGrid oldFloor = selectedBuilding.ParentFloor;
       oldFloor.UnregisterBuilding(selectedBuilding);

       // 3. åœ¨æ–°ä½ç½®æ³¨å†Œ
       bool success = targetFloor.RegisterBuilding(
           selectedBuilding,
           newGridPos
       );

       if (success) {
           // 4. æ‰£é™¤è´¹ç”¨
           ResourceManager.Instance.SpendMoney(moveCost);

           // 5. æ›´æ–°å»ºç­‘å¼•ç”¨
           selectedBuilding.ParentFloor = targetFloor;
           selectedBuilding.GridPosition = newGridPos;

           // 6. æ›´æ–°ä¸–ç•Œä½ç½®
           Vector3 worldPos = targetFloor.GridToWorldPosition(newGridPos);
           selectedBuilding.transform.position = worldPos;

           // 7. é€€å‡ºMoveæ¨¡å¼
           ExitMoveMode();
       } else {
           // å›æ»šï¼šé‡æ–°æ³¨å†Œåˆ°åŸä½ç½®
           oldFloor.RegisterBuilding(selectedBuilding, oldGridPos);
           Debug.LogError("ç§»åŠ¨å¤±è´¥ï¼šç›®æ ‡ä½ç½®ä¸å¯ç”¨");
       }
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] Moveæ¨¡å¼ä¸‹ï¼Œé¼ æ ‡ç§»åŠ¨åˆ°ä¸åŒæ¥¼å±‚ï¼Œé¢„è§ˆè‡ªåŠ¨åˆ‡æ¢
- [ ] åŒæ¥¼å±‚ç§»åŠ¨è´¹ç”¨æ­£ç¡®
- [ ] è·¨æ¥¼å±‚ç§»åŠ¨è´¹ç”¨æ­£ç¡®ï¼ˆÃ—2ï¼‰
- [ ] ç§»åŠ¨æˆåŠŸåå»ºç­‘å‡ºç°åœ¨æ­£ç¡®ä½ç½®
- [ ] åŸä½ç½®çš„ç½‘æ ¼æ­£ç¡®é‡Šæ”¾

**ğŸ“Œ è®°å½•è¦æ±‚**: å®Œæˆååœ¨æ—¥å¿—ä¸­è®°å½•Moveæ¨¡å¼çš„æ”¹åŠ¨è¯¦æƒ…

---

### é˜¶æ®µ4ï¼šè§†è§‰åé¦ˆä¼˜åŒ–

#### ä»»åŠ¡4.1ï¼šå½“å‰æ¥¼å±‚é«˜äº® â±ï¸ é¢„è®¡1å°æ—¶

**ğŸ“ å®æ–½æ­¥éª¤**

1. **åœ¨FloorManagerçš„ `SetFloorHighlight()` æ–¹æ³•ä¸­å®ç°**ï¼ˆå·²åœ¨ä»»åŠ¡2.1ä¸­æä¾›ï¼‰

2. **å¯é€‰ï¼šä½¿ç”¨ä¸“ç”¨Sprite**:
   - åœ¨ `Resources/Sprites/` åˆ›å»ºåŠé€æ˜æ–¹å½¢Sprite
   - åœ¨FloorGridä¸Šé¢„æŒ‚è½½SpriteRenderer
   - é€šè¿‡ä»£ç æ§åˆ¶é¢œè‰²å’Œé€æ˜åº¦

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] å½“å‰æ¥¼å±‚æœ‰æ˜æ˜¾çš„è§†è§‰é«˜äº®ï¼ˆæ·¡è“è‰²ï¼‰
- [ ] éå½“å‰æ¥¼å±‚å‡ ä¹ä¸å¯è§æˆ–æ— é«˜äº®
- [ ] é«˜äº®ä¸é®æŒ¡å»ºç­‘ç‰©ï¼ˆsortingOrderæ­£ç¡®ï¼‰

**ğŸ“Œ è®°å½•è¦æ±‚**: å®Œæˆååœ¨æ—¥å¿—ä¸­è®°å½•é«˜äº®å®ç°æ–¹å¼

---

#### ä»»åŠ¡4.2ï¼šé¼ æ ‡ä¸åœ¨æ¥¼å±‚ä¸Šçš„æç¤º â±ï¸ é¢„è®¡1å°æ—¶

**ğŸ“ å®æ–½æ­¥éª¤**

1. **åˆ›å»ºUIæç¤º**ï¼ˆåœ¨Canvasä¸­ï¼‰:
   ```
   Canvas
   â””â”€ FloorDetectionTip (Panel)
       â””â”€ Text: "Please move your mouse to a floor area"
   ```

2. **åœ¨ConstructionManagerä¸­æ§åˆ¶æ˜¾ç¤º**:
   ```csharp
   [SerializeField] private GameObject floorDetectionTip;

   private void Update()
   {
       if (mode == ConstructionMode.Place || mode == ConstructionMode.Move) {
           bool showTip = (currentDetectedFloor == null);
           floorDetectionTip.SetActive(showTip);
       }
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] é¼ æ ‡ç¦»å¼€æ‰€æœ‰æ¥¼å±‚æ—¶ï¼Œæç¤ºUIæ˜¾ç¤º
- [ ] é¼ æ ‡è¿›å…¥ä»»æ„æ¥¼å±‚æ—¶ï¼Œæç¤ºUIéšè—
- [ ] é€€å‡ºå»ºé€ æ¨¡å¼æ—¶ï¼Œæç¤ºUIéšè—

**ğŸ“Œ è®°å½•è¦æ±‚**: å®Œæˆååœ¨æ—¥å¿—ä¸­è®°å½•UIè·¯å¾„

---

#### ä»»åŠ¡4.3ï¼šæ¥¼å±‚åç§°æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰ â±ï¸ é¢„è®¡30åˆ†é’Ÿ

**ğŸ“ å®æ–½æ­¥éª¤**

1. **åˆ›å»ºUIæ–‡æœ¬**ï¼ˆåœ¨Canvasä¸­ï¼‰:
   ```
   Canvas
   â””â”€ FloorNameDisplay (Text)
       â””â”€ "Building on: 2F"
   ```

2. **ç›‘å¬æ¥¼å±‚åˆ‡æ¢äº‹ä»¶**:
   ```csharp
   private void Start()
   {
       FloorManager.Instance.OnActiveFloorChanged += UpdateFloorNameDisplay;
   }

   private void UpdateFloorNameDisplay(FloorGrid floor)
   {
       if (floor != null) {
           floorNameText.text = $"Building on: {floor.FloorId + 1}F";
       } else {
           floorNameText.text = "";
       }
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] æ¥¼å±‚åˆ‡æ¢æ—¶ï¼Œåç§°æ­£ç¡®æ›´æ–°
- [ ] é€€å‡ºå»ºé€ æ¨¡å¼æ—¶ï¼Œåç§°éšè—

**ğŸ“Œ è®°å½•è¦æ±‚**: å¯é€‰å®ç°ï¼Œå®Œæˆåè®°å½•åˆ°æ—¥å¿—

---

### é˜¶æ®µ5ï¼šè¾¹ç•Œæƒ…å†µå¤„ç†

#### ä»»åŠ¡5.1ï¼šUIé®æŒ¡æ£€æµ‹ â±ï¸ é¢„è®¡30åˆ†é’Ÿ

**ğŸ“ å®æ–½æ­¥éª¤**

1. **å·²åœ¨FloorDetectionServiceä¸­å®ç°**ï¼ˆä»»åŠ¡1.2ï¼‰:
   ```csharp
   if (UnityEngine.EventSystems.EventSystem.current != null &&
       UnityEngine.EventSystems.EventSystem.current.IsPointerOverGameObject()) {
       return null;
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] é¼ æ ‡åœ¨UIæŒ‰é’®ä¸Šæ—¶ï¼Œä¸æ£€æµ‹æ¥¼å±‚
- [ ] é¼ æ ‡åœ¨UIé¢æ¿ä¸Šæ—¶ï¼Œé¢„è§ˆéšè—

**ğŸ“Œ è®°å½•è¦æ±‚**: éªŒè¯åŠŸèƒ½æ­£å¸¸

---

#### ä»»åŠ¡5.2ï¼šå¿«é€Ÿç§»åŠ¨é¼ æ ‡çš„å“åº” â±ï¸ é¢„è®¡30åˆ†é’Ÿ

**ğŸ“ å®æ–½æ­¥éª¤**

1. **è°ƒæ•´æ£€æµ‹é—´éš”**ï¼ˆåœ¨ConstructionManagerä¸­ï¼‰:
   ```csharp
   [SerializeField] private int detectionInterval = 1;  // æ”¹ä¸ºæ¯å¸§æ£€æµ‹
   ```

2. **æ€§èƒ½æµ‹è¯•**:
   - ä½¿ç”¨Profilerç›‘æµ‹Raycastè€—æ—¶
   - å¦‚æœè€—æ—¶ < 0.1msï¼Œå¯ä¿æŒæ¯å¸§æ£€æµ‹
   - å¦‚æœè€—æ—¶ > 0.5msï¼Œæ¢å¤é—´éš”å¸§æ£€æµ‹

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] å¿«é€Ÿç§»åŠ¨é¼ æ ‡ï¼Œé¢„è§ˆè·Ÿéšæµç•…
- [ ] ä¸ä¼šè·³è¿‡ä¸­é—´æ¥¼å±‚
- [ ] å¸§ç‡æ— æ˜æ˜¾ä¸‹é™

**ğŸ“Œ è®°å½•è¦æ±‚**: è®°å½•æœ€ç»ˆé€‰æ‹©çš„æ£€æµ‹é—´éš”

---

#### ä»»åŠ¡5.3ï¼šå»ºé€ æ¨¡å¼é€€å‡ºæ—¶çš„æ¸…ç† â±ï¸ é¢„è®¡30åˆ†é’Ÿ

**ğŸ“ å®æ–½æ­¥éª¤**

1. **ä¿®æ”¹ `ExitPlaceMode()` æ–¹æ³•**:
   ```csharp
   public void ExitPlaceMode()
   {
       // æ¸…ç†é¢„è§ˆ
       if (previewInstance != null) {
           Destroy(previewInstance);
           previewInstance = null;
       }

       // é‡ç½®æ£€æµ‹çŠ¶æ€
       currentDetectedFloor = null;
       lastPreviewFloor = null;

       // éšè—UIæç¤º
       if (floorDetectionTip != null) {
           floorDetectionTip.SetActive(false);
       }

       // æ¢å¤é»˜è®¤æ¥¼å±‚ï¼ˆå¯é€‰ï¼‰
       // FloorManager.Instance.SetActiveFloorProgrammatic(defaultFloor);

       // åˆ‡æ¢æ¨¡å¼
       mode = ConstructionMode.None;
   }
   ```

2. **åŒæ ·ä¿®æ”¹ `ExitMoveMode()` æ–¹æ³•**

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] é€€å‡ºæ¨¡å¼æ—¶ï¼Œæ‰€æœ‰é¢„è§ˆå¯¹è±¡æ­£ç¡®é”€æ¯
- [ ] é€€å‡ºæ¨¡å¼æ—¶ï¼ŒUIæç¤ºéšè—
- [ ] æ— å†…å­˜æ³„æ¼ï¼ˆProfileréªŒè¯ï¼‰

**ğŸ“Œ è®°å½•è¦æ±‚**: è®°å½•æ¸…ç†æµç¨‹

---

### é˜¶æ®µ6ï¼šæ€§èƒ½ä¼˜åŒ–

#### ä»»åŠ¡6.1ï¼šRaycastä¼˜åŒ– â±ï¸ é¢„è®¡1å°æ—¶

**ğŸ“ å®æ–½æ­¥éª¤**

1. **ä½¿ç”¨RaycastNonAlloc**ï¼ˆåœ¨FloorDetectionServiceä¸­ï¼‰:
   ```csharp
   private RaycastHit2D[] hitBuffer = new RaycastHit2D[1];

   private FloorGrid RaycastFloor(Vector2 worldPos)
   {
       int hitCount = Physics2D.RaycastNonAlloc(
           worldPos,
           Vector2.zero,
           hitBuffer,
           0f,
           floorLayer
       );

       if (hitCount > 0 && hitBuffer[0].collider != null) {
           return hitBuffer[0].collider.GetComponent<FloorGrid>();
       }

       return null;
   }
   ```

2. **ç¼“å­˜Cameraå¼•ç”¨**:
   ```csharp
   private Camera cachedCamera;

   public FloorDetectionService(Camera camera, int interval = 3)
   {
       cachedCamera = camera;  // é¿å…æ¯æ¬¡è®¿é—®Camera.main
       // ...
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] Profilerä¸­Raycastè€—æ—¶ < 0.1ms/å¸§
- [ ] æ— GC.Allocï¼ˆä½¿ç”¨NonAllocæ–¹æ³•ï¼‰

**ğŸ“Œ è®°å½•è¦æ±‚**: è®°å½•ä¼˜åŒ–å‰åçš„æ€§èƒ½æ•°æ®

---

#### ä»»åŠ¡6.2ï¼šé¢„è§ˆå¯¹è±¡æ± ï¼ˆå¯é€‰ï¼‰ â±ï¸ é¢„è®¡2å°æ—¶

**ğŸ“ å®æ–½æ­¥éª¤**

1. **åˆ›å»ºå¯¹è±¡æ± ç±»**:
   ```csharp
   public class PreviewObjectPool
   {
       private Queue<GameObject> pool = new Queue<GameObject>();
       private GameObject prefab;

       public GameObject Get();
       public void Return(GameObject obj);
   }
   ```

2. **åœ¨ConstructionManagerä¸­ä½¿ç”¨**:
   ```csharp
   private PreviewObjectPool previewPool;

   private void CreatePreviewInstance()
   {
       previewInstance = previewPool.Get();
       // ... é…ç½®é¢„è§ˆ
   }

   private void SwitchPreviewFloor(FloorGrid newFloor)
   {
       if (previewInstance != null) {
           previewPool.Return(previewInstance);  // è€ŒéDestroy
       }
       // ...
   }
   ```

**âœ… éªŒæ”¶æ ‡å‡†**
- [ ] æ¥¼å±‚åˆ‡æ¢æ—¶æ— Instantiate/Destroyè°ƒç”¨
- [ ] å†…å­˜å ç”¨ç¨³å®š

**ğŸ“Œ è®°å½•è¦æ±‚**: å¯é€‰å®ç°ï¼Œå®Œæˆåè®°å½•æ€§èƒ½æå‡

---

## å››ã€æµ‹è¯•è®¡åˆ’

### 4.1 åŠŸèƒ½æµ‹è¯•æ¸…å•

**åŸºç¡€åŠŸèƒ½** (8é¡¹)
- [ ] T1.1: Placeæ¨¡å¼ä¸‹ï¼Œé¼ æ ‡ç§»åŠ¨åˆ°æ¥¼å±‚Aï¼Œé¢„è§ˆæ­£ç¡®æ˜¾ç¤º
- [ ] T1.2: é¼ æ ‡ç§»åŠ¨åˆ°æ¥¼å±‚Bï¼Œé¢„è§ˆè‡ªåŠ¨åˆ‡æ¢åˆ°æ¥¼å±‚B
- [ ] T1.3: é¼ æ ‡ç§»å‡ºæ‰€æœ‰æ¥¼å±‚ï¼Œé¢„è§ˆéšè—
- [ ] T1.4: é¼ æ ‡é‡æ–°è¿›å…¥æ¥¼å±‚ï¼Œé¢„è§ˆæ¢å¤æ˜¾ç¤º
- [ ] T1.5: ç‚¹å‡»æ”¾ç½®ï¼Œå»ºç­‘å‡ºç°åœ¨æ­£ç¡®æ¥¼å±‚å’Œç½‘æ ¼ä½ç½®
- [ ] T1.6: é¢„è§ˆé¢œè‰²æ­£ç¡®æ˜¾ç¤ºï¼ˆç»¿è‰²=å¯å»ºé€ ï¼Œçº¢è‰²=ä¸å¯ï¼‰
- [ ] T1.7: Moveæ¨¡å¼ä¸‹ï¼ŒåŒæ¥¼å±‚ç§»åŠ¨åŠŸèƒ½æ­£å¸¸
- [ ] T1.8: Moveæ¨¡å¼ä¸‹ï¼Œè·¨æ¥¼å±‚ç§»åŠ¨åŠŸèƒ½æ­£å¸¸ï¼Œè´¹ç”¨Ã—2

**è¾¹ç•Œæµ‹è¯•** (6é¡¹)
- [ ] T2.1: å¿«é€Ÿè·¨æ¥¼å±‚ç§»åŠ¨é¼ æ ‡ï¼Œé¢„è§ˆè·Ÿéšæµç•…
- [ ] T2.2: é¼ æ ‡åœç•™åœ¨æ¥¼å±‚è¾¹ç•Œå¤„ï¼Œé¢„è§ˆç¨³å®šä¸é—ªçƒ
- [ ] T2.3: æ²¡æœ‰å¯ç”¨æ¥¼å±‚æ—¶çš„è¡Œä¸ºï¼ˆå…¨éƒ¨ç¦ç”¨ï¼‰
- [ ] T2.4: åªæœ‰ä¸€ä¸ªæ¥¼å±‚æ—¶çš„è¡Œä¸ºï¼ˆæ— éœ€åˆ‡æ¢ï¼‰
- [ ] T2.5: é¼ æ ‡åœ¨UIä¸Šæ—¶ï¼Œé¢„è§ˆéšè—
- [ ] T2.6: é€€å‡ºå»ºé€ æ¨¡å¼ï¼Œé¢„è§ˆå’ŒUIæ­£ç¡®æ¸…ç†

**å…¼å®¹æ€§æµ‹è¯•** (4é¡¹)
- [ ] T3.1: Tabé”®åŠŸèƒ½ä¿ç•™ï¼ˆå¦‚æœå®ç°ï¼‰
- [ ] T3.2: æ•°å­—é”®åˆ‡æ¢æ¥¼å±‚ï¼ˆå¦‚æœä¿ç•™ï¼‰
- [ ] T3.3: å…¶ä»–ç³»ç»Ÿï¼ˆå¦‚é¡¾å®¢å¯»è·¯ï¼‰ä¸å—å½±å“
- [ ] T3.4: èµ„æºæ‰£è´¹é€»è¾‘æ­£ç¡®ï¼ˆå»ºé€ è´¹ç”¨ã€ç§»åŠ¨è´¹ç”¨ï¼‰

**æ€§èƒ½æµ‹è¯•** (3é¡¹)
- [ ] T4.1: 10ä¸ªæ¥¼å±‚åœºæ™¯ä¸‹ï¼Œå¸§ç‡ > 60fps
- [ ] T4.2: é•¿æ—¶é—´å»ºé€ æ¨¡å¼ï¼ˆ5åˆ†é’Ÿï¼‰ï¼Œæ— å†…å­˜æ³„æ¼
- [ ] T4.3: Profilerä¸­Raycastè€—æ—¶ < 0.1ms/å¸§

### 4.2 æµ‹è¯•æ‰§è¡Œé¡ºåº

1. **é˜¶æ®µå®Œæˆåæµ‹è¯•**ï¼šæ¯å®Œæˆä¸€ä¸ªé˜¶æ®µï¼Œæ‰§è¡Œå¯¹åº”çš„åŠŸèƒ½æµ‹è¯•
2. **é›†æˆæµ‹è¯•**ï¼šæ‰€æœ‰é˜¶æ®µå®Œæˆåï¼Œæ‰§è¡Œå®Œæ•´æµ‹è¯•æ¸…å•
3. **å›å½’æµ‹è¯•**ï¼šä¿®å¤bugåï¼Œé‡æ–°æ‰§è¡Œç›¸å…³æµ‹è¯•ç”¨ä¾‹

### 4.3 æµ‹è¯•è®°å½•è¦æ±‚

æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œåï¼Œåœ¨æ—¥å¿—ä¸­è®°å½•ï¼š
- æµ‹è¯•ç”¨ä¾‹ç¼–å·ï¼ˆå¦‚T1.1ï¼‰
- æµ‹è¯•ç»“æœï¼ˆé€šè¿‡/å¤±è´¥ï¼‰
- å¤±è´¥åŸå› ï¼ˆå¦‚æœå¤±è´¥ï¼‰
- æµ‹è¯•æ—¶é—´

---

## äº”ã€é£é™©ä¸æ³¨æ„äº‹é¡¹

### 5.1 å¤šç›¸æœºåœºæ™¯
**é£é™©**: å¦‚æœæœ‰å¤šä¸ªCameraï¼Œ`Camera.main` å¯èƒ½ä¸æ˜¯å½“å‰ä½¿ç”¨çš„
**è§£å†³æ–¹æ¡ˆ**: åœ¨FloorDetectionServiceæ„é€ å‡½æ•°ä¸­æ³¨å…¥æ­£ç¡®çš„Cameraå¼•ç”¨
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

### 5.2 UIé®æŒ¡
**é£é™©**: é¼ æ ‡åœ¨UIä¸Šæ—¶ï¼ŒRaycastå¯èƒ½ç©¿é€åˆ°æ¥¼å±‚
**è§£å†³æ–¹æ¡ˆ**: å·²åœ¨FloorDetectionServiceä¸­æ·»åŠ  `IsPointerOverGameObject()` æ£€æŸ¥
**ä¼˜å…ˆçº§**: ğŸŸ¢ å·²è§£å†³

### 5.3 Moveæ¨¡å¼å…¼å®¹æ€§
**å†³ç­–**: âœ… **Moveæ¨¡å¼å¿…é¡»æ”¯æŒè‡ªåŠ¨æ£€æµ‹æ¥¼å±‚**
**å®æ–½**: å·²åœ¨é˜¶æ®µ3-ä»»åŠ¡3.3ä¸­è¯¦ç»†è§„åˆ’
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜

### 5.4 æ€§èƒ½å½±å“
**é£é™©**: æ¯å¸§Raycastå¯èƒ½å½±å“æ€§èƒ½
**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨é—´éš”å¸§æ£€æµ‹ï¼ˆé»˜è®¤3å¸§ï¼‰
- ä½¿ç”¨RaycastNonAllocå‡å°‘GC
- ç¼“å­˜æ£€æµ‹ç»“æœ
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

### 5.5 æ¥¼å±‚é‡å 
**é£é™©**: 3Dè§†è§’ä¸‹æ¥¼å±‚å¯èƒ½åœ¨Zè½´é‡å 
**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `Physics2D.RaycastAll` å¹¶é€‰æ‹©æœ€è¿‘çš„
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä½ï¼ˆå½“å‰ä¸º2Dæ¸¸æˆï¼‰

---

## å…­ã€å®æ–½æ—¶é—´çº¿

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|------|------|---------|------|
| é˜¶æ®µ1 | ä»»åŠ¡1.1 | 1å°æ—¶ | æ—  |
| é˜¶æ®µ1 | ä»»åŠ¡1.2 | 2å°æ—¶ | ä»»åŠ¡1.1 |
| é˜¶æ®µ2 | ä»»åŠ¡2.1 | 1å°æ—¶ | æ—  |
| é˜¶æ®µ3 | ä»»åŠ¡3.1 | 0.5å°æ—¶ | ä»»åŠ¡1.2 |
| é˜¶æ®µ3 | ä»»åŠ¡3.2 | 2å°æ—¶ | ä»»åŠ¡2.1, 3.1 |
| é˜¶æ®µ3 | ä»»åŠ¡3.3 | 2å°æ—¶ | ä»»åŠ¡2.1, 3.1 |
| é˜¶æ®µ4 | ä»»åŠ¡4.1-4.3 | 2.5å°æ—¶ | é˜¶æ®µ3å®Œæˆ |
| é˜¶æ®µ5 | ä»»åŠ¡5.1-5.3 | 1.5å°æ—¶ | é˜¶æ®µ3å®Œæˆ |
| é˜¶æ®µ6 | ä»»åŠ¡6.1-6.2 | 3å°æ—¶ | æ‰€æœ‰é˜¶æ®µå®Œæˆ |
| æµ‹è¯• | å®Œæ•´æµ‹è¯• | 3å°æ—¶ | æ‰€æœ‰é˜¶æ®µå®Œæˆ |
| **æ€»è®¡** | | **18.5å°æ—¶** | |

### å…³é”®è·¯å¾„
```
ä»»åŠ¡1.1 â†’ ä»»åŠ¡1.2 â†’ ä»»åŠ¡3.1 â†’ ä»»åŠ¡3.2 â†’ ä»»åŠ¡3.3 â†’ æµ‹è¯•
```

---

## ä¸ƒã€ä»£ç å˜æ›´ç»Ÿè®¡

### æ–°å¢æ–‡ä»¶ (1ä¸ª)
- `Assets/Scripts/Services/FloorDetectionService.cs` (~150è¡Œ)

### ä¿®æ”¹æ–‡ä»¶ (3ä¸ª)
- `Assets/Scripts/Runtime/FloorGrid.cs` (+30è¡Œ)
- `Assets/Scripts/Manager/FloorManager.cs` (+50è¡Œ)
- `Assets/Scripts/Runtime/ConstructionManager.cs` (+200è¡Œ)

### ProjectSettingsé…ç½®
- æ–°å¢Layer: `FloorDetection`
- Layer Collision Matrixé…ç½®

### é¢„è®¡æ€»ä»£ç é‡
- æ–°å¢ä»£ç : ~430è¡Œ
- é‡æ„ä»£ç : ~150è¡Œ
- æ€»è®¡: ~580è¡Œ

---

## å…«ã€éªŒæ”¶æ ‡å‡†

### 8.1 æ ¸å¿ƒåŠŸèƒ½éªŒæ”¶
âœ… Placeæ¨¡å¼ï¼šé¼ æ ‡è‡ªåŠ¨æ£€æµ‹æ¥¼å±‚ï¼Œæ— éœ€æ‰‹åŠ¨åˆ‡æ¢
âœ… Moveæ¨¡å¼ï¼šæ”¯æŒè‡ªåŠ¨æ£€æµ‹æ¥¼å±‚ï¼Œè·¨æ¥¼å±‚ç§»åŠ¨è´¹ç”¨æ­£ç¡®
âœ… é¢„è§ˆè·Ÿéšï¼šé¼ æ ‡ç§»åŠ¨æ—¶ï¼Œé¢„è§ˆæµç•…è·Ÿéš
âœ… è¾¹ç•Œå¤„ç†ï¼šé¼ æ ‡ç¦»å¼€æ¥¼å±‚æ—¶ï¼Œé¢„è§ˆæ­£ç¡®éšè—

### 8.2 æ€§èƒ½éªŒæ”¶
âœ… å¸§ç‡: 10æ¥¼å±‚åœºæ™¯ > 60fps
âœ… å†…å­˜: é•¿æ—¶é—´è¿è¡Œæ— æ³„æ¼
âœ… Raycast: è€—æ—¶ < 0.1ms/å¸§

### 8.3 å…¼å®¹æ€§éªŒæ”¶
âœ… ç°æœ‰åŠŸèƒ½ä¸å—å½±å“ï¼ˆé¡¾å®¢å¯»è·¯ã€èµ„æºç®¡ç†ç­‰ï¼‰
âœ… å¯é€‰ï¼šTabé”®åŠŸèƒ½ä¿ç•™
âœ… ä»£ç è´¨é‡ï¼šæ— ç¼–è¯‘è­¦å‘Šï¼Œç¬¦åˆé¡¹ç›®è§„èŒƒ

---

## ä¹ã€åç»­ä¼˜åŒ–æ–¹å‘

### 9.1 çŸ­æœŸä¼˜åŒ– (å¯é€‰)
- [ ] å¹³æ»‘è¿‡æ¸¡åŠ¨ç”»ï¼šé¢„è§ˆåˆ‡æ¢æ¥¼å±‚æ—¶æ·»åŠ æ·¡å…¥æ·¡å‡º
- [ ] å¿«æ·é”®å¢å¼ºï¼šCtrlé”®ä¸´æ—¶é”å®šæ¥¼å±‚ï¼ˆç²¾ç»†æ“ä½œï¼‰
- [ ] å£°éŸ³åé¦ˆï¼šæ¥¼å±‚åˆ‡æ¢æ—¶æ’­æ”¾éŸ³æ•ˆ

### 9.2 é•¿æœŸä¼˜åŒ– (æœªæ¥ç‰ˆæœ¬)
- [ ] æ™ºèƒ½æ¥¼å±‚æ¨èï¼šæ ¹æ®å»ºç­‘ç±»å‹æ¨èåˆé€‚æ¥¼å±‚
- [ ] å¤šæ¥¼å±‚åŒæ—¶é¢„è§ˆï¼šåŠé€æ˜æ˜¾ç¤ºå…¶ä»–æ¥¼å±‚ç½‘æ ¼
- [ ] VFXæ•ˆæœï¼šæ¥¼å±‚é«˜äº®ä½¿ç”¨ç²’å­æ•ˆæœ

---

## åã€æ–‡æ¡£ç»´æŠ¤

### 10.1 æ–‡æ¡£æ›´æ–°è§„åˆ™
- æ¯æ¬¡ä»»åŠ¡å¼€å§‹å‰ï¼šæ›´æ–°æ—¥å¿—æ–‡æ¡£ï¼Œè®°å½•å¼€å§‹æ—¶é—´
- æ¯æ¬¡ä»»åŠ¡å®Œæˆåï¼šæ›´æ–°æ—¥å¿—æ–‡æ¡£ï¼Œè®°å½•å®ŒæˆçŠ¶æ€å’Œé—®é¢˜
- é‡åˆ°è®¡åˆ’å¤–é—®é¢˜ï¼šåœ¨æ—¥å¿—ä¸­è®°å½•é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- è®¡åˆ’å˜æ›´ï¼šåœ¨æœ¬æ–‡æ¡£ä¸­æ ‡æ³¨å˜æ›´ï¼Œå¹¶åœ¨æ—¥å¿—ä¸­è¯´æ˜åŸå› 

### 10.2 ç›¸å…³æ–‡æ¡£
- **å®æ–½æ—¥å¿—**: `Assets/Documents/é¼ æ ‡è‡ªåŠ¨æ£€æµ‹æ¥¼å±‚å»ºé€ ç³»ç»Ÿ-å®æ–½æ—¥å¿—.md`
- **é¡¹ç›®è§„èŒƒ**: `CLAUDE.md`

---

## é™„å½•

### A. å…³é”®ä»£ç ç‰‡æ®µç´¢å¼•
- FloorDetectionServiceæ ¸å¿ƒé€»è¾‘: é˜¶æ®µ1-ä»»åŠ¡1.2
- FloorManagerç¨‹åºåŒ–åˆ‡æ¢: é˜¶æ®µ2-ä»»åŠ¡2.1
- Placeæ¨¡å¼æ”¹é€ : é˜¶æ®µ3-ä»»åŠ¡3.2
- Moveæ¨¡å¼æ”¹é€ : é˜¶æ®µ3-ä»»åŠ¡3.3

### B. è°ƒè¯•æŠ€å·§
1. **æ£€æŸ¥Raycast**: åœ¨Sceneè§†å›¾ä¸­å¯ç”¨Physics Debugæ˜¾ç¤º
2. **æ£€æŸ¥Collider**: é€‰ä¸­FloorGridæŸ¥çœ‹BoxCollider2Dè¾¹ç•Œ
3. **æ£€æŸ¥Layer**: ç¡®è®¤GameObjectçš„Layerä¸º `FloorDetection`
4. **æ£€æŸ¥äº‹ä»¶**: åœ¨FloorManagerä¸­æ‰“æ–­ç‚¹ï¼Œè§‚å¯Ÿäº‹ä»¶è§¦å‘

### C. å¸¸è§é—®é¢˜æ’æŸ¥
| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|---------|
| é¼ æ ‡æ£€æµ‹ä¸åˆ°æ¥¼å±‚ | Layeræœªè®¾ç½® | æ£€æŸ¥FloorGridçš„Layer |
| é¢„è§ˆä¸åˆ‡æ¢ | äº‹ä»¶æœªè§¦å‘ | æ£€æŸ¥FloorManageräº‹ä»¶è®¢é˜… |
| æ€§èƒ½ä¸‹é™ | æ¯å¸§Raycast | å¢åŠ æ£€æµ‹é—´éš” |
| é¢„è§ˆé—ªçƒ | æ¥¼å±‚è¾¹ç•Œé‡å¤åˆ‡æ¢ | æ·»åŠ åˆ‡æ¢é˜ˆå€¼ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-11
**ä¸‹æ¬¡å®¡æŸ¥**: å®æ–½å®Œæˆå

---

ğŸ“Œ **é‡è¦æé†’**: å¼€å§‹ä»»ä½•ä»»åŠ¡å‰ï¼Œè¯·å…ˆé˜…è¯»å¯¹åº”çš„å®æ–½æ­¥éª¤ï¼Œå¹¶æ›´æ–°å®æ–½æ—¥å¿—ï¼
