# Building Interaction System - Development Log
## 建筑交互系统 - 开发日志

**Project**: Pop Life Simulator
**System**: Building Interaction System
**Start Date**: 2025-10-18

---

## 2025-10-18 | Design Phase

### Design Document Completed | 设计文档完成
- ✅ Created comprehensive design document (建筑交互设计.md)
- ✅ Defined interaction flow: Hover → Click → Double-Click
- ✅ Chose technical stack: LineRenderer for outline, UGUI for UI
- ✅ Designed outline calculation algorithm (外轮廓计算算法)
- ✅ Specified animation timeline (1.5s visible → 0.5s fade → 2s disappear)
- ✅ Created code skeleton templates

### Key Design Decisions | 关键设计决策

#### 1. Outline Highlighting Approach
**Decision**: Use LineRenderer with dynamic vertex calculation
**Alternatives Considered**:
- ❌ Pre-made sprite library (low scalability)
- ❌ UI Image Nine-Slice (poor support for irregular shapes)
- ✅ **LineRenderer** (best balance of flexibility and performance)
- ⚠️ Custom Shader (deferred for advanced features)

**Rationale**: LineRenderer supports irregular building shapes (L-shape, T-shape, etc.) without requiring pre-made assets, and has minimal performance overhead.

#### 2. Double-Click Timing
**Original Proposal**: 2 seconds
**Final Decision**: Keep 2 seconds for bubble lifecycle, but double-click window remains standard 0.5s
**Clarification**:
- Bubble appears on first click
- Bubble fades 1.5s-2s
- If player clicks again within 2s → show detail panel
- This is NOT a "double-click" in traditional sense, but a "click within bubble lifecycle"

#### 3. UI Framework
**Decision**: Use UGUI (Unity GUI) for both bubble and detail panel
**Alternatives Considered**:
- ❌ UI Toolkit (too new, team unfamiliar, project already uses UGUI)
- ✅ **UGUI** (consistent with existing codebase, mature ecosystem)

**Rationale**: Project already uses UGUI extensively (DailySettlementPanel, BankruptcyPanel, etc.). Maintaining consistency reduces learning curve and maintenance cost.

#### 4. File Structure
**Decision**: Place system in `Assets/Scripts/UI/BuildingInteraction/`
**Rationale**: System is primarily UI-focused (outline rendering, info display, panels). Placing it in UI folder makes it easy to find and maintains logical separation.

---

## Implementation Checklist | 实现检查清单

### Phase 1: Core Functionality (Not Started)
- [ ] Create `BuildingInteractionManager.cs`
  - [ ] Singleton pattern
  - [ ] Raycast detection on "interactableShelf" layer
  - [ ] Hover state management
  - [ ] Click detection logic
  - [ ] Double-click within 2s logic

- [ ] Create `BuildingHighlighter.cs`
  - [ ] LineRenderer component setup
  - [ ] `GetAbsoluteCells()` method
  - [ ] `CalculateOutlineVertices()` method
  - [ ] Edge data structure
  - [ ] Outline drawing logic
  - [ ] Show/Hide animations

- [ ] Create `BuildingInfoBubble.cs`
  - [ ] World Space Canvas prefab
  - [ ] Text layout (Name, Level, Stock)
  - [ ] Position above building
  - [ ] Fade in animation (0-0.2s)
  - [ ] Hold visible (0.2s-1.5s)
  - [ ] Fade out animation (1.5s-2s)
  - [ ] Object pooling

- [ ] Create `BuildingDetailPanel.cs`
  - [ ] Screen Space Canvas prefab
  - [ ] Full info layout
  - [ ] Upgrade button
  - [ ] Phase-based button state
  - [ ] Close button
  - [ ] ESC key support

### Phase 2: Integration & Testing (Not Started)
- [ ] Test with ShelfInstance
  - [ ] Display stock correctly
  - [ ] Show category
  - [ ] Upgrade button works

- [ ] Test with FacilityInstance
  - [ ] Display facility type correctly
  - [ ] No stock display for facilities
  - [ ] Upgrade button works

- [ ] Test edge cases
  - [ ] No interaction during construction mode
  - [ ] Handle building destruction
  - [ ] Multi-floor support
  - [ ] Rapid clicking

- [ ] Performance testing
  - [ ] Test with 20+ buildings
  - [ ] Check GC allocations
  - [ ] Measure outline calculation time

### Phase 3: Polish (Not Started)
- [ ] Add cursor change on hover
- [ ] Add upgrade success VFX
- [ ] Add upgrade failed feedback
- [ ] Add sound effects
- [ ] Add hover tooltip delay (0.1s)
- [ ] Add panel close when clicking outside

---

## Technical Notes | 技术笔记

### Outline Calculation Strategy
The key challenge is converting a set of occupied grid cells into a continuous outline loop.

**Algorithm Outline**:
1. For each cell, generate 4 edges (top, right, bottom, left)
2. Add all edges to a HashSet
3. Remove duplicate edges (these are internal edges)
4. Remaining edges form the boundary
5. Sort and connect edges into a loop
6. Convert grid coordinates to world coordinates

**Example**:
```
Input: Cells [(0,0), (1,0), (1,1)]  (L-shape)

Step 1: Generate edges
Cell (0,0): [(0,0)-(1,0), (1,0)-(1,1), (1,1)-(0,1), (0,1)-(0,0)]
Cell (1,0): [(1,0)-(2,0), (2,0)-(2,1), (2,1)-(1,1), (1,1)-(1,0)]
Cell (1,1): [(1,1)-(2,1), (2,1)-(2,2), (2,2)-(1,2), (1,2)-(1,1)]

Step 2: Find duplicates
(1,0)-(1,1) appears twice → internal edge → remove
(1,1)-(2,1) appears twice → internal edge → remove

Step 3: Remaining boundary edges
[(0,0)-(1,0), (1,0)-(2,0), (2,0)-(2,1), (2,1)-(2,2),
 (2,2)-(1,2), (1,2)-(1,1), (1,1)-(0,1), (0,1)-(0,0)]

Step 4: Connect into loop and convert to world coordinates
```

### Grid to World Coordinate Conversion
Use `FloorGrid.GridToWorld()` method:
```csharp
Vector3 worldPos = floorGrid.GridToWorld(gridPos);
// Returns: originPos + (gridPos.x * cellSize, gridPos.y * cellSize, 0)
```

**Important**: Each floor has its own origin, so always use the correct FloorGrid instance.

### Getting FloorGrid from BuildingInstance
```csharp
FloorGrid floor = FloorManager.Instance.GetFloor(building.floorId);
```

---

## Known Issues | 已知问题

### Design Phase Issues
None (design phase complete, implementation not started)

---

## Performance Considerations | 性能考虑

### Outline Calculation Optimization
- **Target**: < 1ms per outline calculation
- **Strategy**:
  - Cache outline vertices when building doesn't move
  - Use simple HashSet operations (O(n))
  - Limit max vertices to 100

### Raycast Optimization
- **Issue**: Per-frame raycasts can be expensive
- **Solution**: Only raycast when mouse moves
  ```csharp
  if (Input.mousePosition != lastMousePosition) {
      DoRaycast();
  }
  ```

### UI Object Pooling
- **Issue**: Creating/destroying bubbles causes GC
- **Solution**: Object pool with 5 pre-created bubbles

---

## Future Improvements | 未来改进

### Advanced Outline Effects
- Animated outline (shader-based flowing effect)
- Glow/bloom effect on hover
- Different colors for different building types

### Additional Interactions
- Right-click quick menu
- Multi-select (Shift+Click)
- Drag to move (combine with ConstructionManager)

### Accessibility
- Screen reader support
- Keyboard navigation
- Customizable hotkeys
- High contrast mode

---

## Dependencies & Prerequisites | 依赖与前置条件

### Required Unity Systems
- ✅ Physics2D (built-in)
- ✅ UGUI (built-in)
- ⚠️ DOTween (optional, for smooth animations)

### Required Project Systems
- ✅ `BuildingInstance` / `ShelfInstance` / `FacilityInstance`
- ✅ `BuildingArchetype` / `ShelfArchetype` / `FacilityArchetype`
- ✅ `FloorGrid` (GridToWorld conversion)
- ✅ `FloorManager` (floor access)
- ✅ `DayLoopManager` (phase detection)
- ✅ `ResourceManager` (Fame consumption for upgrades)
- ✅ `ConstructionManager` (mode detection)

### Required Layers
- ✅ "interactableShelf" layer (already exists, buildings already have BoxCollider2D)

---

## Questions & Answers | 问答记录

### Q1: Why not use UI Toolkit?
**A**: Project already uses UGUI extensively. UI Toolkit is mature in Unity 6, but switching would require team learning and refactoring existing code. For this feature, UGUI is sufficient and maintains consistency.

### Q2: Why LineRenderer instead of Shader?
**A**: LineRenderer is easier to implement and debug, supports irregular shapes natively, and has minimal performance overhead for our use case (< 20 buildings visible at once). Shader solution can be added later for advanced visual effects.

### Q3: How to handle multi-floor buildings?
**A**: Raycast automatically detects the correct building regardless of floor, since each building has its own BoxCollider2D. Outline is drawn in world space at the building's actual position. No manual floor switching needed.

### Q4: What if building is destroyed while bubble is showing?
**A**: Check if `lastClickedBuilding` is null before accessing it. Unity's null check on destroyed objects returns true. Hide bubble/panel immediately if building is destroyed.

### Q5: How to prevent interaction during construction mode?
**A**: Check `ConstructionManager.Instance.currentMode`. If it's `ConstructionMode.Place` or `ConstructionMode.Move`, disable interaction system.

---

## References | 参考资料

### Unity Documentation
- [LineRenderer](https://docs.unity3d.com/Manual/class-LineRenderer.html)
- [Physics2D.Raycast](https://docs.unity3d.com/ScriptReference/Physics2D.Raycast.html)
- [Canvas](https://docs.unity3d.com/Manual/UICanvas.html)

### Project Documentation
- `CLAUDE.md` - Project guidelines
- `建筑交互设计.md` - This system's design document

---

## Changelog | 更新日志

### 2025-10-18
- Created design document
- Created development log
- Defined technical architecture
- Specified implementation phases

---

**Next Steps**: Begin Phase 1 implementation (BuildingInteractionManager)

**Status**: 🟡 Design Complete, Implementation Pending

---

**End of Log**
